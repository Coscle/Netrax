---
- name: Restore config from backup file
  hosts: "{{ target_device }}"
  gather_facts: no

  vars:
    backup_server: ubuntu-backup              # 백업 서버 인벤토리 이름
    backup_root: /data/network-backups        # 백업 루트 디렉터리
    restore_file: "{{ backup_root }}/{{ target_device }}/{{ restore_filename }}"

  tasks:
    # 1) 어떤 장비 / 어떤 파일로 복구하는지 출력
    - name: Show info
      ansible.builtin.debug:
        msg:
          - "RESTORE DEVICE : {{ inventory_hostname }}"
          - "RESTORE FILE   : {{ restore_file }}"

    # 2) 백업 서버에서 해당 파일 내용 읽어오기 (Base64)
    - name: Read restore file from backup server
      delegate_to: "{{ backup_server }}"
      ansible.builtin.slurp:
        src: "{{ restore_file }}"
      register: restore_raw
      changed_when: false

     # 2-1) 디버그 - slurp로 읽어온 원본 내용(복호화) 확인
    #       (실제 장비 config 그대로라, 필요하면 잠깐만 켜두고 나중엔 주석 처리해도 됨)
    - name: Debug decoded restore file content
      ansible.builtin.debug:
        msg: "{{ restore_raw.content | b64decode }}"

    # 3) Base64 → 텍스트 → 줄 리스트로 변환
    - name: Build restore_lines fact
      ansible.builtin.set_fact:
        restore_lines: "{{ (restore_raw.content | b64decode).split('\n') }}"

    # 3-1) 디버그 - 몇 줄인지 + 앞부분만 확인
    - name: Debug restore_lines summary
      ansible.builtin.debug:
        msg:
          - "Total lines in restore_lines: {{ restore_lines | length }}"
          - "First 10 lines:"
          - "{{ restore_lines[0:10] | join('\n') }}"
          
    # === 여기서부터 OS 별로 복구 ===

    # 4-1) IOS 장비 복구 (Access-1 같은 것)
    - name: Push full config to IOS
      when: ansible_network_os == "cisco.ios.ios"
      cisco.ios.ios_config:
        lines: "{{ restore_lines }}"
        save_when: always    

    # 4-2) NX-OS 장비 복구 (HQ-Core-N5K-1 같은 것)
    - name: Push full config to NX-OS
      when: ansible_network_os == "cisco.nxos.nxos"
      cisco.nxos.nxos_config:
        lines: "{{ restore_lines }}"
        save_when: always

    # 4-3) ASA 복구 (원하면 나중에 튜닝)
    - name: Push full config to ASA
      when: ansible_network_os == "cisco.asa.asa"
      cisco.asa.asa_config:
        lines: "{{ restore_lines }}"
        # ASA 모듈은 replace 옵션이 없어서, 전체 config 텍스트를 merge하는 형태야.
