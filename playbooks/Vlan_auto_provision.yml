---
- name: Auto VLAN creation and trunk update
  hosts: hq
  gather_facts: no

  vars:
    vlan_id: "{{ vlan_id }}"
    vlan_name: "{{ vlan_name }}"
    trunk_ports:
      - "port-channel25"

  tasks:

    - name: Show task info
      debug:
        msg:
          - "Target switch: {{ inventory_hostname }}"
          - "VLAN: {{ vlan_id }} ({{ vlan_name }})"

    # 1) VLAN ìƒì„±
    - name: Create VLAN on IOS
      when: ansible_network_os == "cisco.ios.ios"
      cisco.ios.ios_config:
        lines:
          - "vlan {{ vlan_id }}"
          - "name {{ vlan_name }}"

    - name: Create VLAN on NXOS
      when: ansible_network_os == "cisco.nxos.nxos"
      cisco.nxos.nxos_config:
        lines:
          - "vlan {{ vlan_id }}"
          - "name {{ vlan_name }}"

    # 2) Trunk ì—…ë°ì´íŠ¸
    - name: Update trunk allowed VLANs
      loop: "{{ trunk_ports }}"
      loop_control:
        loop_var: trunk
      cisco.ios.ios_config:
        parents: "interface {{ trunk }}"
        lines:
          - "switchport trunk allowed vlan add {{ vlan_id }}"
      when: ansible_network_os == "cisco.ios.ios"

    - name: Update trunk VLANs (NXOS)
      loop: "{{ trunk_ports }}"
      loop_control:
        loop_var: trunk
      cisco.nxos.nxos_config:
        parents: "interface {{ trunk }}"
        lines:
          - "switchport trunk allowed vlan add {{ vlan_id }}"
      when: ansible_network_os == "cisco.nxos.nxos"

    # 3) Save
    - name: Save config (IOS)
      when: ansible_network_os == "cisco.ios.ios"
      cisco.ios.ios_command:
        commands: "write memory"

    - name: Save config (NXOS)
      when: ansible_network_os == "cisco.nxos.nxos"
      cisco.nxos.nxos_command:
        commands: "copy run start"

    # 4) Email Report
    - name: Send email report
      delegate_to: ubuntu-backup
      ansible.builtin.mail:
        host: smtp.gmail.com
        port: 587
        username: "netrax99@gmail.com"
        password: "mlbblfzggsnzwkdp"
        to: "genarain7@gmail.com"
        subject: "[NETRAX] VLAN {{ vlan_id }} ({{ vlan_name }}) ìƒì„± ì™„ë£Œ"
        body: |
          ì‹ ê·œ VLAN ìƒì„± ë° Trunk ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

          ğŸ“Œ VLAN ì •ë³´
          - VLAN ID: {{ vlan_id }}
          - VLAN Name: {{ vlan_name }}

          ğŸ“Œ ì ìš© ì¥ë¹„
          - {{ inventory_hostname }}

          ğŸ“Œ ì—…ë°ì´íŠ¸ëœ Trunk í¬íŠ¸
          {{ trunk_ports | join('\n - ') }}

          ì‘ì—…ì€ AWX ìë™í™” ì‹œìŠ¤í…œì— ì˜í•´ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.
