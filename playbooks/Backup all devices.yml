---
- name: Backup all devices
  hosts: all
  gather_facts: no

  vars:
    # 예: 20251127-123000
    backup_timestamp: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"
    # EE 컨테이너에서의 프로젝트 디렉터리 아래에 backup 폴더 사용
    backup_base_dir: "/runner/project/backups"

  tasks:
    - name: Backup config
      ansible.netcommon.cli_command:
        command: show run
      register: backup

    - name: Ensure backup directory exists on PVC
      delegate_to: localhost
      file:
        path: "{{ backup_base_dir }}/{{ inventory_hostname }}"
        state: directory
        mode: '0755'

    - name: Save backup to file on PVC
      delegate_to: localhost
      copy:
        content: "{{ backup.stdout[0] | default(backup.stdout) }}"
        dest: "{{ backup_base_dir }}/{{ inventory_hostname }}/{{ inventory_hostname }}-{{ backup_timestamp }}.cfg"
