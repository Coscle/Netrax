---
- name: Assign access port for employee
  hosts: "{{ target_switch }}"
  gather_facts: no

  vars:
    backup_server: ubuntu-backup

    # 기본 VLAN (매핑에 없을 때 fallback)
    default_data_vlan: 10

    # SMTP (이미 백업 플레이북에서 쓰던 값 재사용 가능)
    smtp_host: "smtp.gmail.com"
    smtp_port: 587
    smtp_user: "netrax99@gmail.com"
    smtp_pass: "mlbblfzggsnzwkdp"
    notify_mail_to: "genarain7@gmail.com"

    # 부서별 VLAN
    dept_vlan_map:
      HR:      { data: 10 }
      SALES:   { data: 20 }
      FINANCE: { data: 30 }
      IT:      { data: 40 }
      LOG1:    { data: 50 }
      LOG2:    { data: 50 }
      LOG3:    { data: 50 }
      LOG4:    { data: 50 }
      MAT:     { data: 60 }
      MKT:     { data: 70 }
      EXEC:    { data: 80 }

  tasks:
    - name: Show basic info
      debug:
        msg:
          - "Target switch    : {{ inventory_hostname }}"
          - "Interface CLI    : {{ access_interface }}"
          - "Department       : {{ department }}"

    # 1) 부서 → VLAN 매핑
    - name: Calculate data VLAN from department
      set_fact:
        data_vlan: >-
          {{ (dept_vlan_map.get(department, {})).data
             | default(default_data_vlan) }}

    # 2) VLAN 존재 여부와 상관없이 생성(있으면 그대로 유지)
    - name: Ensure data VLAN exists
      cisco.ios.ios_config:
        lines:
          - "vlan {{ data_vlan }}"
          - " name {{ department | upper }}_DATA"
      when: data_vlan is defined

    # 3) 인터페이스 Access 구성 (설문에서 받은 CLI를 그대로 사용)
    - name: Configure access port(s) with raw CLI
      vars:
        iface_desc: "{{ department | upper }}"
      ansible.netcommon.cli_command:
        command: "{{ item }}"
      loop:
        - "configure terminal"
        - "{{ access_interface }}"               # 예: int e1/1  또는  int r e0/0-3, e1/0-3, e2/0-3
        - "description {{ iface_desc }}"
        - "switchport mode access"
        - "switchport access vlan {{ data_vlan }}"
        - "spanning-tree portfast edge"
        - "spanning-tree bpduguard enable"
        - "no shutdown"
        - "end"
      register: port_cfg
      changed_when: true   # cli_command는 changed 정보가 없으니 항상 변경으로 처리

    # 4) running-config 저장
    - name: Save running-config
      when: port_cfg.changed
      cisco.ios.ios_command:
        commands:
          - write memory

    # 5) 이메일 알림
    - name: Send notification email
      when: port_cfg.changed
      delegate_to: "{{ backup_server }}"
      ansible.builtin.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_user | default(omit) }}"
        password: "{{ smtp_pass | default(omit) }}"
        to: "{{ notify_mail_to }}"
        subject: "[NETRAX] 신규 직원 포트 할당 - {{ inventory_hostname }} / {{ access_interface }}"
        body: |
          신규 직원 포트 할당 작업이 완료되었습니다.

          ■ 부서
            - Department : {{ department }}
            - VLAN       : {{ data_vlan }}

          ■ 인터페이스 범위 (입력값 기준)
            - {{ access_interface }}

          ■ 장비 / 포트
            - 스위치    : {{ inventory_hostname }}
            - 인터페이스: {{ access_interface }}

          이 메일은 Ansible AWX 자동화 작업에 의해 발송되었습니다.
