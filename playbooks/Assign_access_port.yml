---
- name: Assign access port for employee
  hosts: "{{ target_switch }}"
  gather_facts: no

  vars:
    backup_server: ubuntu-backup

    # ê¸°ë³¸ VLAN (ë§¤í•‘ì— ì—†ì„ ë•Œ fallback)
    default_data_vlan: 10

    # SMTP (ì´ë¯¸ ë°±ì—… í”Œë ˆì´ë¶ì—ì„œ ì“°ë˜ ê°’ ì¬ì‚¬ìš© ê°€ëŠ¥)
    smtp_host: "smtp.gmail.com"
    smtp_port: 587
    smtp_user: "netrax99@gmail.com"
    smtp_pass: "ohqo bcje rqjt gkix"
    notify_mail_to: "genarain7@gmail.com"

    # ë¶€ì„œë³„ VLAN
    dept_vlan_map:
      HR:      { data: 10 }
      SALES:   { data: 20 }
      FINANCE: { data: 30 }
      IT:      { data: 40 }
      LOG1:    { data: 50 }
      LOG2:    { data: 50 }
      LOG3:    { data: 50 }
      LOG4:    { data: 50 }
      MAT:     { data: 60 }
      MKT:     { data: 70 }
      EXEC:    { data: 80 }

  tasks:
    - name: Show basic info
      debug:
        msg:
          - "Target switch    : {{ inventory_hostname }}"
          - "Interface CLI    : {{ access_interface }}"
          - "Department       : {{ department }}"

    # 1) ë¶€ì„œ â†’ VLAN ë§¤í•‘
    - name: Calculate data VLAN from department
      set_fact:
        data_vlan: >-
          {{ (dept_vlan_map.get(department, {})).data
             | default(default_data_vlan) }}

    # 2) VLAN ì¡´ì¬ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ ìƒì„±(ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€)
    - name: Ensure data VLAN exists
      cisco.ios.ios_config:
        lines:
          - "vlan {{ data_vlan }}"
          - " name {{ department | upper }}_DATA"
      when: data_vlan is defined

    # 3) ì¸í„°í˜ì´ìŠ¤ Access êµ¬ì„± (ì„¤ë¬¸ì—ì„œ ë°›ì€ CLIë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
    - name: Configure access port(s) with raw CLI
      vars:
        iface_desc: "{{ department | upper }}"
      ansible.netcommon.cli_command:
        command: "{{ item }}"
      loop:
        - "configure terminal"
        - "{{ access_interface }}"               # ì˜ˆ: int e1/1  ë˜ëŠ”  int r e0/0-3, e1/0-3, e2/0-3
        - "description {{ iface_desc }}"
        - "switchport mode access"
        - "switchport access vlan {{ data_vlan }}"
        - "spanning-tree portfast edge"
        - "spanning-tree bpduguard enable"
        - "no shutdown"
        - "end"
      register: port_cfg
      changed_when: true   # cli_commandëŠ” changed ì •ë³´ê°€ ì—†ìœ¼ë‹ˆ í•­ìƒ ë³€ê²½ìœ¼ë¡œ ì²˜ë¦¬

    # 4) running-config ì €ì¥
    - name: Save running-config
      when: port_cfg.changed
      cisco.ios.ios_command:
        commands:
          - write memory

        # 5) ì´ë©”ì¼ ì•Œë¦¼ (ì—…ê·¸ë ˆì´ë“œ ë²„ì „)
    - name: Send notification email
      when: port_cfg.changed
      delegate_to: "{{ backup_server }}"
      ansible.builtin.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_user | default(omit) }}"
        password: "{{ smtp_pass | default(omit) }}"
        to: "{{ notify_mail_to }}"
        subject: "ğŸ”” [NETRAX ìë™í™”] Access í¬íŠ¸ ì„¤ì • ì™„ë£Œ â€“ {{ inventory_hostname }}"
        body: |
          ğŸ“¡ NETRAX ë„¤íŠ¸ì›Œí¬ ìë™í™” ì‹œìŠ¤í…œ ì•Œë¦¼

          ì‹ ê·œ ì§ì›/ìë¦¬ ë°°ì¹˜ë¥¼ ìœ„í•œ Access Port êµ¬ì„±ì´
          âœ… ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‰


          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 1. ë¶€ì„œ & VLAN ì •ë³´           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â€¢ ë¶€ì„œ (Department) : {{ department }}
          â€¢ Access VLAN       : {{ data_vlan }}


          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 2. ì ìš©ëœ ì¸í„°í˜ì´ìŠ¤           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â€¢ ëŒ€ìƒ ìŠ¤ìœ„ì¹˜       : {{ inventory_hostname }}
          â€¢ ì¸í„°í˜ì´ìŠ¤ ì…ë ¥ê°’ : {{ access_interface }}


          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 3. ê³µí†µ ì ìš© ì„¤ì • (IOS)        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â€¢ description {{ department | upper }}
          â€¢ switchport mode access
          â€¢ switchport access vlan {{ data_vlan }}
          â€¢ spanning-tree portfast edge
          â€¢ spanning-tree bpduguard enable
          â€¢ no shutdown


          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 4. ì‘ì—… ë©”íƒ€ ì •ë³´              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â€¢ ì‹¤í–‰ í”Œë ˆì´ë¶ : Assign access port for employee
          â€¢ ìë™í™” í”Œë«í¼ : Ansible AWX


          ğŸ›  ì°¸ê³ 
          ë³¸ ë©”ì¼ì€ NETRAX ë„¤íŠ¸ì›Œí¬ ìë™í™” ì‹œìŠ¤í…œì—ì„œ
          ì‘ì—… ì™„ë£Œ ì‹œ ìë™ ë°œì†¡ëœ ì•Œë¦¼ì…ë‹ˆë‹¤.

          ë¬¸ì œê°€ ë°œìƒí•˜ê±°ë‚˜ ì¶”ê°€ í™•ì¸ì´ í•„ìš”í•  ê²½ìš°
          ë„¤íŠ¸ì›Œí¬íŒ€ì— ë¬¸ì˜í•´ ì£¼ì„¸ìš”. ê°ì‚¬í•©ë‹ˆë‹¤. ğŸ™‚
