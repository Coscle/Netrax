---
- name: Backup all devices and notify on change
  hosts: nxos:ios:asa          # ì¥ë¹„ë“¤ë§Œ ëŒ€ìƒ (backup_server ê·¸ë£¹ì€ ì œì™¸)
  gather_facts: no

  vars:
    # ë°±ì—… íŒŒì¼ëª…ì— ë¶™ì¼ íƒ€ì„ìŠ¤íƒ¬í”„
    backup_timestamp: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

    # ë°±ì—… ì„œë²„ ì¸ë²¤í† ë¦¬ í˜¸ìŠ¤íŠ¸ëª… (ubuntu-backup)
    backup_server: ubuntu-backup

    # ë°±ì—…ì´ ìŒ“ì¼ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ (ìš°ë¶„íˆ¬ ì„œë²„ ê¸°ì¤€)
    backup_root: /data/network-backups

    # ===== SMTP / ì•Œë¦¼ ì„¤ì • =====
    smtp_host: "smtp.gmail.com"      # íšŒì‚¬ SMTP ì„œë²„ ì£¼ì†Œ
    smtp_port: 587                     # 25, 465, 587 ì¤‘ í•˜ë‚˜
    smtp_user: "netrax99@gmail.com"   # í•„ìš” ì—†ìœ¼ë©´ ì‚­ì œ
    smtp_pass: "mlbblfzggsnzwkdp"            # ê°€ëŠ¥í•˜ë©´ ë‚˜ì¤‘ì— Credentialë¡œ ë¹¼ê¸°
    notify_mail_to: "genarain7@gmail.com"  # ì•Œë¦¼ ë°›ì„ ë©”ì¼ ì£¼ì†Œ

  tasks:
    # 1) ì¥ë¹„ì—ì„œ running-config ê°€ì ¸ì˜¤ê¸°
    - name: Backup config from device
      ansible.netcommon.cli_command:
        command: show run
      register: backup
             
    # 2) ë°±ì—… ë””ë ‰í„°ë¦¬ ìƒì„± (ìš°ë¶„íˆ¬ ë°±ì—… ì„œë²„)
    - name: Ensure backup directory exists on backup server
      delegate_to: "{{ backup_server }}"
      file:
        path: "{{ backup_root }}/{{ inventory_hostname }}"
        state: directory
        mode: '0755'

    # 3) ìƒˆ ë°±ì—… íŒŒì¼ ì €ì¥
    - name: Save backup file on backup server
      delegate_to: "{{ backup_server }}"
      copy:
        content: "{{ backup.stdout | default(backup.stdout_lines | join('\n')) }}"
        dest: "{{ backup_root }}/{{ inventory_hostname }}/{{ inventory_hostname }}-{{ backup_timestamp }}.cfg"
      register: saved_backup

    # 4) ì´ ì¥ë¹„ì˜ ê¸°ì¡´ ë°±ì—… íŒŒì¼ ëª©ë¡ ì¡°íšŒ
    - name: Find existing backups for this device
      delegate_to: "{{ backup_server }}"
      find:
        paths: "{{ backup_root }}/{{ inventory_hostname }}"
        patterns: "*.cfg"
        file_type: file
      register: backup_files

    # 5) mtime ê¸°ì¤€ìœ¼ë¡œ ìµœì‹ ìˆœ ì •ë ¬ + ìµœì‹ /ì´ì „ íŒŒì¼ ë³€ìˆ˜ë¡œ ì •ë¦¬
    - name: Prepare backup file info
      set_fact:
        backups_sorted: "{{ backup_files.files | sort(attribute='mtime', reverse=True) }}"
        latest_file:  "{{ (backup_files.files | sort(attribute='mtime', reverse=True))[0].path }}"
        previous_file: >-
          {{ (backup_files.files | sort(attribute='mtime', reverse=True))[1].path
             if (backup_files.files | length) > 1 else None }}
        is_first_backup: "{{ (backup_files.files | length) == 1 }}"

     # 6) ì´ì „ ë°±ì—…ì´ ìˆì„ ë•Œë§Œ diff ìˆ˜í–‰
    #   - NX-OS: !Time ì¤„ì€ ë¬´ì‹œí•˜ê³  ë¹„êµ
    #   - ê·¸ ì™¸ ì¥ë¹„: ê¸°ì¡´ì²˜ëŸ¼ ê·¸ëŒ€ë¡œ diff
    - name: Diff with previous backup (ignore NX-OS !Time header)
      when: not is_first_backup
      delegate_to: "{{ backup_server }}"
      command: |
        bash -lc '
        # ìµœì‹  ë°±ì—… íŒŒì¼ì´ NX-OS í˜•ì‹ì¸ì§€ ì²´í¬
        if grep -q "^!Command: show running-config" "{{ latest_file }}"; then
          # NX-OS: ë§¤ë²ˆ ë°”ë€ŒëŠ” !Time ì¤„ì€ ì œê±°í•˜ê³  ë¹„êµ
          sed -E "/^!Time:/d" "{{ previous_file }}" \
            > /tmp/prev_{{ inventory_hostname }}.cfg

          sed -E "/^!Time:/d" "{{ latest_file }}" \
            > /tmp/last_{{ inventory_hostname }}.cfg

          diff -u /tmp/prev_{{ inventory_hostname }}.cfg /tmp/last_{{ inventory_hostname }}.cfg
        else
          # IOS ë“± ë‚˜ë¨¸ì§€ëŠ” ì›ë³¸ ê·¸ëŒ€ë¡œ ë¹„êµ
          diff -u "{{ previous_file }}" "{{ latest_file }}"
        fi
        '
      register: diff_result
      failed_when: diff_result.rc not in [0, 1]    # 0: ê°™ìŒ, 1: ë‹¤ë¦„, ê·¸ ì™¸: ì—ëŸ¬
      changed_when: diff_result.rc == 1

    # 7) ì²« ë°±ì—…ì¼ ë•Œ ë³´ë‚´ëŠ” ë©”ì¼ (baseline ìƒì„± ì•Œë¦¼ìš©)
    - name: Send email for first backup
      when: is_first_backup
      delegate_to: "{{ backup_server }}"
      ansible.builtin.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_user | default(omit) }}"
        password: "{{ smtp_pass | default(omit) }}"
        to: "{{ notify_mail_to }}"
        subject: "[NETRAX-INFO] {{ inventory_hostname }} ì²« ë°±ì—… ìƒì„± (Baseline)"
        subtype: html
        body: |
          <html>
          <body style="font-family: Arial, sans-serif;">
            <h3 style="color: #1a73e8;">âœ… ì²« ë°±ì—… ìƒì„± ì™„ë£Œ ì•Œë¦¼</h3>
            <p><strong>{{ inventory_hostname }}</strong> ì¥ë¹„ì˜ ì²« ì„¤ì • ë°±ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ë°±ì—… íŒŒì¼ì€ í–¥í›„ ì„¤ì • ë³€ê²½ ê°ì§€ì˜ <strong>ê¸°ì¤€(Baseline)</strong>ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
            
            <table style="border-collapse: collapse; width: 60%;">
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2; width: 150px;"><strong>ì¥ë¹„ í˜¸ìŠ¤íŠ¸ëª…</strong></td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ inventory_hostname }}</td>
              </tr>
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2;"><strong>ë°±ì—… ì‹œê°„</strong></td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ backup_timestamp }}</td>
              </tr>
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2;"><strong>ì €ì¥ ê²½ë¡œ</strong></td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ latest_file }}</td>
              </tr>
            </table>

            <p style="margin-top: 20px; font-size: 12px; color: #757575;">ì´ ë©”ì¼ì€ ë„¤íŠ¸ì›Œí¬ ìë™í™” ì‹œìŠ¤í…œ(NETRAX)ì—ì„œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
          </body>
          </html>

    # 8) ì´ì „ ë°±ì—…ê³¼ ë‚´ìš©ì´ ë‹¬ë¼ì¡Œì„ ë•Œë§Œ ë©”ì¼ ë°œì†¡
    - name: Send email when config changed
      when:
        - not is_first_backup
        - diff_result.changed | default(false)
      delegate_to: "{{ backup_server }}"
      ansible.builtin.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_user | default(omit) }}"
        password: "{{ smtp_pass | default(omit) }}"
        to: "{{ notify_mail_to }}"
        subject: "[NETRAX-ALERT] ì„¤ì • ë³€ê²½ ê°ì§€: {{ inventory_hostname }}"
        subtype: html
        body: |
          <html>
          <body style="font-family: Arial, sans-serif;">
            <h3 style="color: #d93025;">ğŸš¨ ì„¤ì • ë³€ê²½ ê°ì§€ ì•Œë¦¼</h3>
            <p><strong>{{ inventory_hostname }}</strong> ì¥ë¹„ì—ì„œ ì´ì „ ë°±ì—…ê³¼ ë¹„êµí•˜ì—¬ ì„¤ì • ë³€ê²½ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ë„í•˜ì§€ ì•Šì€ ë³€ê²½ì¸ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤.</p>

            <p><strong>ë³€ê²½ ë¹„êµ ëŒ€ìƒ:</strong></p>
            <ul style="list-style-type: none; padding-left: 0;">
              <li><strong>ì´ì „ ë°±ì—…:</strong> {{ previous_file }}</li>
              <li><strong>ìµœì‹  ë°±ì—…:</strong> {{ latest_file }} ({{ backup_timestamp }})</li>
            </ul>

            <h4 style="color: #202124;">ğŸ“œ ë³€ê²½ ë‚´ìš© (Diff Output)</h4>
            <pre style="background-color: #f8f9fa; border: 1px solid #dadce0; padding: 15px; overflow-x: auto; font-family: monospace, Courier New; font-size: 14px;">
{{ diff_result.stdout }}
            </pre>

            <p style="margin-top: 20px; font-size: 12px; color: #757575;">ì´ ë©”ì¼ì€ ë„¤íŠ¸ì›Œí¬ ìë™í™” ì‹œìŠ¤í…œ(NETRAX)ì—ì„œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
          </body>
          </html>
