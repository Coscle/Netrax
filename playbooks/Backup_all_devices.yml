---
- name: Backup all devices and notify on change
  hosts: nxos:ios:asa          # ì¥ë¹„ë“¤ë§Œ ëŒ€ìƒ (backup_server ê·¸ë£¹ì€ ì œì™¸)
  gather_facts: no

  vars:
    # ë°±ì—… íŒŒì¼ëª…ì— ë¶™ì¼ íƒ€ì„ìŠ¤íƒ¬í”„
    backup_timestamp: "{{ lookup('pipe', 'TZ=Asia/Seoul date +%Y%m%d-%H%M%S') }}"

    # ë°±ì—… ì„œë²„ ì¸ë²¤í† ë¦¬ í˜¸ìŠ¤íŠ¸ëª… (ubuntu-backup)
    backup_server: ubuntu-backup

    # ë°±ì—…ì´ ìŒ“ì¼ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ (ìš°ë¶„íˆ¬ ì„œë²„ ê¸°ì¤€)
    backup_root: /data/network-backups

    # ===== SMTP / ì•Œë¦¼ ì„¤ì • =====
    smtp_host: "smtp.gmail.com"      # íšŒì‚¬ SMTP ì„œë²„ ì£¼ì†Œ
    smtp_port: 587                     # 25, 465, 587 ì¤‘ í•˜ë‚˜
    smtp_user: "netrax99@gmail.com"   # í•„ìš” ì—†ìœ¼ë©´ ì‚­ì œ
    smtp_pass: "ohqo bcje rqjt gkix"            # ê°€ëŠ¥í•˜ë©´ ë‚˜ì¤‘ì— Credentialë¡œ ë¹¼ê¸°
    notify_mail_to: "genarain7@gmail.com"  # ì•Œë¦¼ ë°›ì„ ë©”ì¼ ì£¼ì†Œ

  tasks:
    # 1) ì¥ë¹„ì—ì„œ running-config ê°€ì ¸ì˜¤ê¸°
    - name: Backup config from device
      ansible.netcommon.cli_command:
        command: show run
      register: backup
             
    # 2) ë°±ì—… ë””ë ‰í„°ë¦¬ ìƒì„± (ìš°ë¶„íˆ¬ ë°±ì—… ì„œë²„)
    - name: Ensure backup directory exists on backup server
      delegate_to: "{{ backup_server }}"
      file:
        path: "{{ backup_root }}/{{ inventory_hostname }}"
        state: directory
        mode: '0755'

    # 3) ìƒˆ ë°±ì—… íŒŒì¼ ì €ì¥
    - name: Save backup file on backup server
      delegate_to: "{{ backup_server }}"
      copy:
        content: "{{ backup.stdout | default(backup.stdout_lines | join('\n')) }}"
        dest: "{{ backup_root }}/{{ inventory_hostname }}/{{ inventory_hostname }}-{{ backup_timestamp }}.cfg"
      register: saved_backup

    # 4) ì´ ì¥ë¹„ì˜ ê¸°ì¡´ ë°±ì—… íŒŒì¼ ëª©ë¡ ì¡°íšŒ
    - name: Find existing backups for this device
      delegate_to: "{{ backup_server }}"
      find:
        paths: "{{ backup_root }}/{{ inventory_hostname }}"
        patterns: "*.cfg"
        file_type: file
      register: backup_files

    # 5) mtime ê¸°ì¤€ìœ¼ë¡œ ìµœì‹ ìˆœ ì •ë ¬ + ìµœì‹ /ì´ì „ íŒŒì¼ ë³€ìˆ˜ë¡œ ì •ë¦¬
    - name: Prepare backup file info
      set_fact:
        backups_sorted: "{{ backup_files.files | sort(attribute='mtime', reverse=True) }}"
        latest_file:  "{{ (backup_files.files | sort(attribute='mtime', reverse=True))[0].path }}"
        previous_file: >-
          {{ (backup_files.files | sort(attribute='mtime', reverse=True))[1].path
             if (backup_files.files | length) > 1 else None }}
        is_first_backup: "{{ (backup_files.files | length) == 1 }}"

     # 6) ì´ì „ ë°±ì—…ì´ ìˆì„ ë•Œë§Œ diff ìˆ˜í–‰
    #   - NX-OS: !Time ì¤„ì€ ë¬´ì‹œí•˜ê³  ë¹„êµ
    #   - ê·¸ ì™¸ ì¥ë¹„: ê¸°ì¡´ì²˜ëŸ¼ ê·¸ëŒ€ë¡œ diff
    - name: Diff with previous backup (ignore NX-OS !Time header)
      when: not is_first_backup
      delegate_to: "{{ backup_server }}"
      command: |
        bash -lc '
        # ìµœì‹  ë°±ì—… íŒŒì¼ì´ NX-OS í˜•ì‹ì¸ì§€ ì²´í¬
        if grep -q "^!Command: show running-config" "{{ latest_file }}"; then
          # NX-OS: ë§¤ë²ˆ ë°”ë€ŒëŠ” !Time ì¤„ì€ ì œê±°í•˜ê³  ë¹„êµ
          sed -E "/^!Time:/d" "{{ previous_file }}" \
            > /tmp/prev_{{ inventory_hostname }}.cfg

          sed -E "/^!Time:/d" "{{ latest_file }}" \
            > /tmp/last_{{ inventory_hostname }}.cfg

          diff -u /tmp/prev_{{ inventory_hostname }}.cfg /tmp/last_{{ inventory_hostname }}.cfg
        else
          # IOS ë“± ë‚˜ë¨¸ì§€ëŠ” ì›ë³¸ ê·¸ëŒ€ë¡œ ë¹„êµ
          diff -u "{{ previous_file }}" "{{ latest_file }}"
        fi
        '
      register: diff_result
      failed_when: diff_result.rc not in [0, 1]    # 0: ê°™ìŒ, 1: ë‹¤ë¦„, ê·¸ ì™¸: ì—ëŸ¬
      changed_when: diff_result.rc == 1

      # 7) ì²« ë°±ì—…ì¼ ë•Œ ë³´ë‚´ëŠ” ë©”ì¼ (baseline ìƒì„± ì•Œë¦¼ìš©)
    - name: Send email for first backup
      when: is_first_backup
      delegate_to: "{{ backup_server }}"
      ansible.builtin.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_user | default(omit) }}"
        password: "{{ smtp_pass | default(omit) }}"
        to: "{{ notify_mail_to }}"
        subject: "ğŸ§¾ [NETRAX ìë™í™”] ì²« ë°±ì—… ìƒì„± â€“ {{ inventory_hostname }}"
        body: |
          ğŸ“¡ NETRAX ë„¤íŠ¸ì›Œí¬ ìë™í™” ì‹œìŠ¤í…œ ì•Œë¦¼

          {{ inventory_hostname }} ì¥ë¹„ì— ëŒ€í•œ
          âœ… ì²« ë²ˆì§¸ ì„¤ì • ë°±ì—…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‰

          ì´ ë°±ì—…ì€ ì´í›„ ë³€ê²½ ê°ì§€ì˜ ê¸°ì¤€ì´ ë˜ëŠ”
          ğŸ”– Baseline ì„¤ì • íŒŒì¼ì…ë‹ˆë‹¤.


          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 1. ë°±ì—… ëŒ€ìƒ ì •ë³´              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â€¢ ì¥ë¹„ ì´ë¦„  : {{ inventory_hostname }}
          â€¢ ë°±ì—… ì„œë²„  : {{ backup_server }}


          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 2. ìƒì„±ëœ ë°±ì—… íŒŒì¼ ê²½ë¡œ       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â€¢ íŒŒì¼ ìœ„ì¹˜  : {{ latest_file }}
          â€¢ ë°±ì—… ì‹œê°  : {{ backup_timestamp }}


          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 3. ì‘ì—… ë©”íƒ€ ì •ë³´              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â€¢ ì‹¤í–‰ í”Œë ˆì´ë¶ : Backup all devices and notify on change
          â€¢ ìë™í™” í”Œë«í¼ : Ansible AWX


          ğŸ›  ì°¸ê³ 
          ë³¸ ë©”ì¼ì€ NETRAX ë„¤íŠ¸ì›Œí¬ ìë™í™” ì‹œìŠ¤í…œì—ì„œ
          ì²« ë°±ì—… ìˆ˜í–‰ ì‹œ ìë™ ë°œì†¡ëœ ì•Œë¦¼ì…ë‹ˆë‹¤.

          ë°±ì—… ì •ì±… ë³€ê²½ ë˜ëŠ” ë³µêµ¬ í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•  ê²½ìš°
          ë„¤íŠ¸ì›Œí¬íŒ€ì— ë¬¸ì˜í•´ ì£¼ì„¸ìš”. ê°ì‚¬í•©ë‹ˆë‹¤. ğŸ™‚


    # 8) ì´ì „ ë°±ì—…ê³¼ ë‚´ìš©ì´ ë‹¬ë¼ì¡Œì„ ë•Œë§Œ ë©”ì¼ ë°œì†¡
    - name: Send email when config changed
      when:
        - not is_first_backup
        - diff_result.changed | default(false)
      delegate_to: "{{ backup_server }}"
      ansible.builtin.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_user | default(omit) }}"
        password: "{{ smtp_pass | default(omit) }}"
        to: "{{ notify_mail_to }}"
        subject: "âš ï¸ [NETRAX ìë™í™”] ì„¤ì • ë³€ê²½ ê°ì§€ â€“ {{ inventory_hostname }}"
        body: |
          ğŸ“¡ NETRAX ë„¤íŠ¸ì›Œí¬ ìë™í™” ì‹œìŠ¤í…œ ì•Œë¦¼

          {{ inventory_hostname }} ì¥ë¹„ì—ì„œ
          ğŸ” ì´ì „ ë°±ì—… ëŒ€ë¹„ ì„¤ì • ë³€ê²½ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.


          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 1. ì¥ë¹„ & ë°±ì—… íŒŒì¼ ì •ë³´       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â€¢ ì¥ë¹„ ì´ë¦„      : {{ inventory_hostname }}
          â€¢ ì´ì „ ë°±ì—… íŒŒì¼ : {{ previous_file }}
          â€¢ ìµœì‹  ë°±ì—… íŒŒì¼ : {{ latest_file }}
          â€¢ ë°±ì—… ì‹œê°      : {{ backup_timestamp }}


          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 2. ì£¼ìš” ë³€ê²½ ë‚´ìš© (diff -u)    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ì•„ë˜ëŠ” ì´ì „ ë°±ì—…ê³¼ ìµœì‹  ë°±ì—… ê°„ì˜ diff ê²°ê³¼ì…ë‹ˆë‹¤.

          {{ diff_result.stdout | default('(diff ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.)') }}


          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 3. ì‘ì—… ë©”íƒ€ ì •ë³´              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â€¢ ì‹¤í–‰ í”Œë ˆì´ë¶ : Backup all devices and notify on change
          â€¢ ìë™í™” í”Œë«í¼ : Ansible AWX


          ğŸ›  ì•ˆë‚´
          ì˜ë„í•˜ì§€ ì•Šì€ ë³€ê²½ì´ ì•„ë‹ˆë¼ë©´
          ë³€ê²½ ì´ë ¥(ì‘ì—…ì / ë³€ê²½ ì‚¬ìœ )ì„ í•¨ê»˜ ê¸°ë¡í•´ ì£¼ì„¸ìš”.

          ë³€ê²½ ë‚´ìš©ì— ëŒ€í•œ ê²€í† ê°€ í•„ìš”í•˜ê±°ë‚˜
          ë¡¤ë°±ì´ í•„ìš”í•  ê²½ìš° ë„¤íŠ¸ì›Œí¬íŒ€ì— ë¬¸ì˜í•´ ì£¼ì„¸ìš”. ğŸ™‚
